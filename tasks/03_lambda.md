# タスク: ステップ3 - ユーザー定義関数 (fn) とクロージャの実装

## 現在の状況

* `src/Spinor/Syntax.hs`: AST定義
* `src/Spinor/Val.hs`: 値の定義 (VInt, VBool, VPrim)
* `src/Spinor/Eval.hs`: 評価器 (define, 変数参照, プリミティブ適用)
* REPL で四則演算と変数の定義が動作中。

## 目標

**「関数を定義し、適用できる言語」** にする。
1. `fn` (lambda) 構文をサポートする。
2. 関数を適用 (`apply`) できるようにする。
3. レキシカルスコープ（クロージャ）を実装する。

## 実装詳細指示

### 1. リファクタリング: 相互再帰の解決

`Val` (値) が `VFunc` コンストラクタで `Env` (環境) を保持する必要がありますが、`Env` も `Val` を保持するため、循環参照が発生します。
* **解決策:** `src/Spinor/Val.hs` (または `Types.hs`) に `Val` と `Env` の両方の定義をまとめ、`Eval.hs` からインポートするように構成を変更してください。

### 2. `Val` 型の拡張

* `VFunc` コンストラクタを追加:
    * `VFunc [Text] Expr Env`
    * (引数名のリスト, 関数本体の式, 定義時の環境)

### 3. `src/Spinor/Eval.hs` の修正

* **特殊形式 `fn` の評価:**
    * `(fn (arg1 arg2) body)` のようなリストをパースする。
    * 現在の環境 (`get` で取得) をキャプチャし、`VFunc` に格納して返す。
* **関数適用 (`apply`) のロジック拡張:**
    * 現在は `VPrim` (プリミティブ) しか対応していませんが、`VFunc` も適用できるようにする。
    * `VFunc params body closureEnv` を適用する場合:
        1. 引数 (実引数) を評価する。
        2. `closureEnv` (保存された環境) をベースに、`params` と `実引数` のペアを登録した「新しい環境」を作成する。
        3. その「新しい環境」の下で `body` を評価する (`local` 関数などを利用)。

### 4. `app/Main.hs` の確認

* REPL で以下が動くことを目指す。
    * `((fn (x) (* x x)) 10)` -> 100
    * `(define add (fn (a b) (+ a b)))` -> `(add 10 20)` -> 30
    * `(define make-adder (fn (n) (fn (x) (+ x n))))` -> `((make-adder 5) 10)` -> 15 (クロージャのテスト)

## 出力要件

* 変更が必要なファイル (`src/Spinor/Types.hs` 等への移動があればそれも含め) のコード全体を提示すること。
* 日本語で簡潔に解説すること。

# 実装結果
