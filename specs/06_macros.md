# Spinor ユーザー定義マクロ 仕様

## 1. 概要

マクロは、Spinor における最も強力な抽象化機能の一つである。通常の関数が「値」を操作するのに対し、マクロは「コード（AST）」そのものを操作する。

マクロは評価フェーズの前に「展開 (expansion)」というステップを挟むことで、コードを受け取って新しいコードを生成する。これにより、`when` や `cond` のような新しい制御構造や、ドメイン固有言語 (DSL) を Spinor 自身で実装することが可能になる。

## 2. マクロの定義 (特殊形式 `mac`)

マクロは、`fn` とよく似た `mac` という特殊形式を用いて定義される。

*   **構文**: `(mac (param1 ...) body)`
    *   `fn` と同様に、固定長、可変長（全キャプチャ）、ドット記法による可変長引数をサポートする。

*   **評価**: `mac` 式が評価されると、`VFunc` と同様に、現在の環境、仮引数リスト、関数本体をキャプチャーした `VMacro` オブジェクトが生成される。この時点ではマクロの本体 `body` は評価されない。

## 3. マクロの評価（展開プロセス）

マクロの評価は、通常の関数適用とは根本的に異なる、以下の「展開と再評価」のプロセスを辿る。

1.  **マクロ呼び出しの検出**:
    評価器がリスト `(macro-name arg1 arg2 ...)` に遭遇し、先頭の `macro-name` が `VMacro` に束縛されていることを認識する。

2.  **引数の非評価**:
    後続の引数 `arg1`, `arg2`, ... は **評価されない**。これらは AST ノードのまま、マクロ本体に渡される。
    *(内部的には、評価を伴わない `exprToVal` のような変換を経て `Val` として渡される)*

3.  **マクロ本体の実行**:
    `VMacro` の本体が実行される。本体の目的は、引数として渡されたコード片を元に、`list`, `cons`, `quote` (`'`) などを駆使して、**実行したい新しいコード片をリスト (`VList`) として構築し、返すこと**である。

4.  **コードの再評価 (Re-evaluation)**:
    マクロ本体が返した新しいコード片（`VList` など）を、評価器が AST (`Expr`) に逆変換し、その場で **再度 `eval` する**。

5.  **最終結果**:
    この再評価の結果が、元のマクロ呼び出し式 `(macro-name ...)` 全体の最終的な評価結果となる。

## 4. 関数とマクロの決定的な違い

| 項目 | 関数 (`VFunc`) | マクロ (`VMacro`) |
| :--- | :--- | :--- |
| **引数の扱い** | 呼び出し時に **評価される** (値が渡る) | 呼び出し時に **評価されない** (コードが渡る) |
| **戻り値** | 計算結果である **値** | 実行されるべき **コード** |

## 5. 実装例 (`twister/core.spin` より)

### `when` マクロ

`when` マクロは、`cond` が真のときだけ `body` を実行する。

*   **定義**:
    ```scheme
    (def when (mac (cond body)
      (list 'if cond body #f)))
    ```
*   **展開プロセス**:
    1.  `(when (> 4 1) (print "ok"))` という式を評価。
    2.  引数 `(> 4 1)` と `(print "ok")` は評価されずにマクロ本体に渡される。
    3.  マクロ本体は `(list 'if '(> 4 1) '(print "ok") '#f)` を実行し、`'(if (> 4 1) (print "ok") #f)` という新しいコードを返す。
    4.  評価器が、この返されたコードを再度評価する。

### `let` マクロ

簡易的な `let` は、関数適用 (`lambda`) の糖衣構文として実装される。

*   **定義**:
    ```scheme
    (def let (mac (var val body)
      (list (list 'fn (list var) body) val)))
    ```
*   **展開プロセス**:
    1.  `(let x 10 (* x x))` という式を評価。
    2.  引数 `x`, `10`, `(* x x)` がマクロ本体に渡される。
    3.  マクロ本体は `(list (list 'fn (list 'x) '(* x x)) '10)` を実行し、`'((fn (x) (* x x)) 10)` という新しいコードを返す。
    4.  評価器が、この返されたコードを再度評価する。
