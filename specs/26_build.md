# Step 26: スタンドアロン コンパイル - 技術仕様

## 1. 概要

本仕様は、Step 25 で構築したトランスパイラ基盤を拡張し、Spinor プログラムから直接ネイティブ実行可能バイナリを生成する `spinor build` コマンドの技術仕様を定義する。

このステップの核となる機能は、`defun` によるトップレベル関数定義のサポートと、C コンパイラとの連携である。

## 2. `spinor build` コマンドの仕様

### 2.1. コマンド形式

```sh
spinor build [OPTIONS] <input-file.spin>
```

### 2.2. 処理フロー

`spinor build foo.spin` を実行した際の内部処理フローは以下の通りである。

1.  **パース:** `foo.spin` を読み込み、パースして Spinor AST (`[Expr]`) のリストに変換する。
2.  **コード生成:** AST を C99 ソースコードにトランスパイルする (`foo.c` を生成)。この際、`defun` は C のグローバル関数に、それ以外のトップレベル式は `main` 関数内の文に変換される。
3.  **コンパイラ呼び出し:** システムにインストールされている C コンパイラ (`gcc` または `clang`) を外部プロセスとして起動する。
    -   コマンド例: `gcc -o foo foo.c runtime/spinor.c`
    -   `runtime/spinor.c` を静的にリンクし、ランタイム関数をバイナリに含める。
4.  **リンク:** C コンパイラがオブジェクトファイルを生成し、ランタイムとリンクして最終的な実行可能ファイル (`foo` または `foo.exe`) を生成する。
5.  **クリーンアップ:** C コンパイルが成功した場合、中間ファイルである `foo.c` は自動的に削除される。コンパイルが失敗した場合は、デバッグ目的で `foo.c` を残す。

### 2.3. 出力ファイル

-   入力が `path/to/foo.spin` の場合、出力バイナリは `path/to/foo` (Windowsでは `path/to/foo.exe`) となる。

## 3. 関数定義 (`defun`) のトランスパイル仕様

`defun` フォームを C の関数に変換するためのルールを定義する。

### 3.1. 基本的な変換ルール

Spinor の `defun` 式は、`SpObject*` を引数に取り `SpObject*` を返す C のグローバル関数に変換される。

-   **Spinor コード:**
    ```lisp
    (defun add (x y)
      (+ x y))
    ```

-   **生成される C コード:**
    ```c
    SpObject* user_add(SpObject* x, SpObject* y) {
        return sp_add(x, y);
    }
    ```

### 3.2. シンボル名のマングリング (Name Mangling)

Spinor の関数名と C の予約語や既存のランタイム関数名との衝突を避けるため、以下のマングリング規則を適用する。

1.  **プレフィックス:** すべてのユーザー定義関数名には `user_` プレフィックスを付与する。
2.  **文字置換:** Spinor のシンボルで許可されているが C の識別子では許可されていない文字 (`-` など) は `_` に置換する。

-   `my-func` -> `user_my_func`
-   `calculate!` -> `user_calculate_` (仮)

### 3.3. 関数呼び出しの変換

Spinor での関数呼び出しは、マングリングされた C 関数への呼び出しに変換される。

-   **Spinor コード:**
    ```lisp
    (add 10 20)
    ```

-   **生成される C コード:**
    ```c
    user_add(sp_make_int(10), sp_make_int(20))
    ```

### 3.4. `Codegen` の責務分割

`src/Spinor/Compiler/Codegen.hs` は、入力された AST リスト (`[Expr]`) を以下の2種類に分類して処理する必要がある。

1.  **`defun` 式:** C のトップレベル関数定義に変換する。
2.  **その他のトップレベル式:** `main` 関数内に逐次実行される文（評価と `sp_print` の呼び出し）に変換する。

最終的に生成される C ソースは、これら2つの要素を結合した単一のファイルとなる。
