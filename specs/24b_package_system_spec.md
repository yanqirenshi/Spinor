# 24b: パッケージ操作系マクロ (Package Utilities) 仕様書

## 1. 概要
Spinor における静的なモジュール管理（Step 19）を補完し、実行時に名前空間を動的に定義・切り替え・結合するためのパッケージシステムを導入する。これにより、REPL 上でのコンテキスト切り替えや、複数のライブラリを統合した環境の構築が可能になる。

## 2. アーキテクチャとデータモデル

### 2.1 環境 (Context) の拡張
現在の `Env` (単一の `Map Text Val`) を、複数のパッケージを保持するグローバルな実行状態に拡張する。

- **Package データ構造:**
    - `name`: パッケージ名 (例: `"user"`, `"math"`)
    - `bindings`: そのパッケージで定義されたトップレベルシンボルのマップ。
    - `exports`: 外部に公開するシンボルの集合。
    - `usedPackages`: `use-package` によってインポートされたパッケージ名のリスト。

- **GlobalState:**
    - `currentPackage`: 現在評価中のパッケージ名。デフォルトは `"user"`。
    - `packages`: パッケージ名をキーとする `Package` のマップ。初期状態で `"spinor"` (プリミティブ用) と `"user"` を含む。

### 2.2 シンボル解決ルール
シンボル `sym` を評価する際の検索順序を以下のように拡張する：

1. **レキシカルスコープ:** 現在の `let` や `fn` の引数などのローカル束縛。
2. **カレントパッケージ:** `currentPackage` 内の `bindings`。
3. **インポート済みシンボル:** `currentPackage` の `usedPackages` を順次辿り、各パッケージの `exports` に含まれるシンボルを検索する。
4. **コア:** 組み込みの `spinor` パッケージ。

## 3. プリミティブとマクロ

### `(defpackage "PKG-NAME" (:use "BASE-PKG") (:export "SYM1" "SYM2"))`
- **機能:** 新しいパッケージを定義する。
- **オプション:**
    - `:use`: 公開シンボルを取り込むパッケージを指定。
    - `:export`: このパッケージが外部に公開するシンボルをリストで指定。

### `(in-package "PKG-NAME")`
- **機能:** 現在の評価コンテキスト（`currentPackage`）を指定したパッケージに切り替える。
- **挙動:** REPL のプロンプトや、以降の `def` による定義先に影響を与える。

### `(use-package "PKG-NAME")`
- **機能:** 指定したパッケージの `exports` を現在のパッケージの検索パスに追加する。
- **競合時:** 既存のシンボルと衝突した場合は警告を出すか、現在の定義を優先する。

## 4. ドキュメント戦略
- `manual/public/docs/syntax/packages.md` を更新し、`module`（ファイル単位）と `package`（動的名前空間）の使い分けを明示する。
- REPL での `(in-package "my-lib")` による実験的な開発フローをユーザーガイドに追記する。
