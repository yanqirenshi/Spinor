# Step 29: SLY / SLIME Support (TCP Socket Integration) - 技術仕様

## 1. 概要

本仕様は、Spinor 処理系を Emacs Lisp の開発環境である SLY (SLIME) から利用可能にするための第一歩として、TCP ソケットサーバー機能の実装に関する技術仕様を定義する。

最終目標は Swank プロトコルを実装することだが、このステップではまず、単純なテキストベースの REPL プロトコルを確立する。

## 2. コマンドライン仕様

Spinor 処理系をサーバーモードで起動するためのサブコマンドを新設する。

### 2.1. コマンド形式

```sh
spinor server [--port <port>]
```

-   **`server`:** サーバーモードで起動するサブコマンド。
-   **`--port <port>`:** (オプション) サーバーが待ち受ける TCP ポート番号を指定する。指定がない場合のデフォルトポートは **`4005`** とする。これは SLIME が標準的に使用するポート番号である。

## 3. 通信プロトコル (Phase 1)

Swank プロトコルの複雑さを避け、まずは基本的な対話を実現するためのシンプルなテキストベースのプロトコルを定義する。

### 3.1. 接続モデル

-   サーバーは指定されたポートで TCP 接続を待ち受ける (listen)。
-   クライアントからの接続要求を受け入れる (accept) と、セッションを開始する。
-   セッションは、クライアントが接続を切断するまで継続する。
-   サーバープロセス自体は、一つのセッションが終了しても停止せず、次のクライアントからの接続を待機し続ける。

### 3.2. データ交換

-   **エンコーディング:** 通信はすべて UTF-8 で行う。
-   **リクエスト:** クライアントは、評価させたい S式 を1行のテキストとして送信する。メッセージの終端は改行文字 (`
`) とする。
    ```
    (+ 1 2)

    ```
-   **レスポンス:** サーバーは受信した S式 をパース・評価し、結果を1行のテキストとしてクライアントに送り返す。レスポンスの終端も改行文字 (`
`) とする。
    -   成功時: 評価結果の `Val` を文字列化したもの。
        ```
        3

        ```
    -   失敗時: パースエラーまたは評価エラーのメッセージ。
        ```
        エラー: 未定義のシンボル: non-existent-var

        ```

### 3.3. セッションの状態

-   各クライアント接続（セッション）は、独立した評価環境 (`Env`) を持つ。
-   `define` や `setq` による環境の変更は、同一セッション内でのみ有効であり、他のセッションには影響しない。
-   サーバーは、セッション内で REPL と同様に、状態を維持しながら対話的に評価を実行する。

## 4. エラーハンドリング

サーバーの堅牢性を確保するため、以下のエラーハンドリングを行う。

-   **パースエラー:** クライアントから受信した文字列が S式 として不正な場合、サーバーはクラッシュせず、エラーメッセージをレスポンスとして返す。
-   **評価エラー:** 未定義変数の参照など、評価中にエラーが発生した場合も同様に、サーバーはクラッシュせず、エラーメッセージを返す。
-   **接続エラー:** クライアントが予期せず接続を切断した場合など、ソケット通信に関する I/O エラーが発生しても、サーバープロセスは終了せず、次の接続を待機し続ける。エラーが発生した特定のスレッドのみを終了させる。
