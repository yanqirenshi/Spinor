# 22. 制御構文の拡充 (Control Flow Macros)

## 1. 概要 (Overview)

Common Lisp との互換性を高め、より表現力豊かなコードを記述できるようにするため、基本的な制御構文をマクロとして `twister/core.spin` に実装する。

ここで定義するマクロは、`if` と `fn` という最小限のプリミティブを組み合わせて実現される。

## 2. 仕様 (Specifications)

### 2.1. `defun`

-   **種別:** マクロ
-   **構文:** `(defun name lambda-list ...body)`

**説明:**
関数を定義するための糖衣構文。トップレベルに関数を定義するために用いる。`lambda-list` は関数の引数リスト、`body` は関数の本体となる複数の式。

**展開:**
`(defun name (arg1 arg2) expr1 expr2)` は以下の形式に展開される。
`(def name (fn (arg1 arg2) expr1 expr2))`

---

### 2.2. `when` / `unless`

-   **種別:** マクロ
-   **構文:** `(when condition ...body)`
-   **構文:** `(unless condition ...body)`

**説明:**
`if` のより限定的な形式。

-   `when`: `condition` が真 (truthy) の場合にのみ `body` を順次評価する。偽 (falsy, `#f`) の場合は `#f` を返す。
-   `unless`: `condition` が偽 (`#f`) の場合にのみ `body` を順次評価する。真の場合は `#f` を返す。

`body` は暗黙の `progn` として扱われ、最後の式の評価結果がマクロ全体の返り値となる。

**展開:**
-   `(when cond e1 e2)` は `(if cond ((fn () e1 e2)) #f)` に展開される。
-   `(unless cond e1 e2)` は `(if cond #f ((fn () e1 e2)))` に展開される。

---

### 2.3. `cond`

-   **種別:** マクロ
-   **構文:** `(cond (predicate1 ...body1) (predicate2 ...body2) ...)`

**説明:**
複数の条件分岐を記述するためのマクロ。各節 `(predicate ...body)` は順に評価される。

-   `predicate` を評価し、その結果が真であった最初の節を見つける。
-   その節の `body` を評価し、最後の式の評価結果を `cond` 式全体の返り値とする。
-   もし `body` が省略されている `(predicate)` という形式の節で `predicate` が真になった場合、`predicate` の評価結果自身が返り値となる。
-   いずれの `predicate` も真にならなかった場合、`#f` を返す。

**展開:**
`cond` はネストした `if` 式に展開される。
`(cond (p1 e1) (p2 e2))` は `(if p1 e1 (if p2 e2 #f))` のように展開される。

---

### 2.4. `and` / `or`

-   **種別:** マクロ
-   **構文:** `(and ...forms)`
-   **構文:** `(or ...forms)`

**説明:**
短絡評価を行う論理演算マクロ。

-   **`and`**: `forms` を左から右へ順に評価する。いずれかのフォームが `#f` を返した時点で評価を中断し、`#f` を返す。すべてのフォームが真の値を返した場合、最後のフォームの評価結果を返す。引数がない `(and)` は `#t` を返す。
-   **`or`**: `forms` を左から右へ順に評価する。いずれかのフォームが真の値を返した時点で評価を中断し、その値を返す。すべてのフォームが `#f` を返した場合、`#f` を返す。引数がない `(or)` は `#f` を返す。

**展開:**
`and` と `or` もネストした `if` 式に展開される。
-   `(and x y)` は `(if x y #f)` に展開される。
-   `(or x y)` は `(if x x y)` に展開される。（`let` がないため、`x` が2回評価される可能性があることに注意）

```

