# Spinor Twister (ブートストラップ・ライブラリ) 仕様

## 1. 概要

Twister は、Spinor 言語自身で書かれた標準ライブラリ群である。このライブラリは、REPL 起動時に自動的に読み込まれ（ブートストラップ）、基本的な関数やマクロ、リスト操作、数学関数などを提供する。

この仕組みは **「カーネルは単純に、ライブラリは豊富に」** という設計思想に基づいている。Haskellで実装された最小限のコア機能（パーサー、評価器、`load` などの数個のプリミティブ）を「Spinorカーネル」とし、それ以外のほとんどの機能をSpinor言語で記述された「Twisterライブラリ」として分離している。

## 2. ロードメカニズム

Twister のロードは、`load` 特殊形式とブートストラップ処理によって実現される。

### 2.1. `load` 特殊形式

*   **構文**: `(load "path/to/file.spin")`
*   **動作**: `load` はHaskellで実装された特殊形式で、以下の処理を実行する。
    1.  引数として渡された文字列をファイルパスと解釈する。
    2.  指定されたファイルを読み込む。
    3.  ファイルの内容を、複数のSpinorの式 (`Expr`) のリストとしてパースする。
    4.  パースされた式を、ファイルの先頭から順に現在の評価環境で逐次評価する。

### 2.2. ブートストラップ処理

1.  Spinor REPL の起動時、ホストプログラム (`Main.hs`) は `./twister/boot.spin` ファイルが存在するかどうかを確認する。
2.  ファイルが存在する場合、REPLがユーザー入力を待つ前に、`(load "twister/boot.spin")` を自動的に実行する。
3.  `boot.spin` は、他のすべてのライブラリファイルを `load` する責務を持つ。

このブートストラップ機構により、REPL起動時にはTwisterライブラリのすべての機能が利用可能な状態となる。

## 3. 提供ライブラリ

Twister は、機能ごとにモジュール化された複数の `.spin` ファイルから構成される。

### 3.1. `boot.spin`

ブートストラップ処理のエントリポイント。以下の順序でコアライブラリを読み込む。
1.  `twister/core.spin`
2.  `twister/list.spin`
3.  `twister/math.spin`

### 3.2. `core.spin` - 基本関数とマクロ

最も基本的な関数と、言語の制御構造を拡張するマクロを提供する。

*   **関数**:
    *   `(not x)`: 真偽値を反転させる。
    *   `(id x)`: 引数をそのまま返す。
*   **マクロ**:
    *   `(when cond body)`: `cond` が真の場合のみ `body` を評価する。
    *   `(let var val body)`: `val` を評価した結果を `var` に束縛し、`body` を評価する。
    *   `(cond (p1 e1) (p2 e2) ...)`: 最初の真である述語 `p` に対応する式 `e` を評価する、多岐分岐。

### 3.3. `list.spin` - リスト操作

高階関数を含む、標準的なリスト操作関数を提供する。

*   `(null? xs)`: リストが空かどうかを判定する (`empty?` プリミティブのラッパー)。
*   `(map f xs)`: リスト `xs` の各要素に `f` を適用した新しいリストを返す。
*   `(length xs)`: リスト `xs` の長さを返す。
*   `(append xs ys)`: 2つのリスト `xs` と `ys` を連結する。
*   `(foldl f acc xs)`: 左畳み込み (left fold)。
*   `(foldr f acc xs)`: 右畳み込み (right fold)。
*   `(reverse xs)`: リスト `xs` の要素を逆順にした新しいリストを返す。

### 3.4. `math.spin` - 数学関数

基本的な数学ユーティリティ関数を提供する。

*   `(even? n)`: 整数 `n` が偶数なら `#t` を返す。
*   ` (odd? n)`: 整数 `n` が奇数なら `#t` を返す。
*   `(fact n)`: `n` の階乗を計算する（再帰のデモ）。
*   `(fib n)`: `n` 番目のフィボナッチ数を計算する（再帰のデモ）。
