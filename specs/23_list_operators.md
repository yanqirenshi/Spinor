# 機能仕様書: リスト操作ユーティリティ

## 概要
`twister/list.spin` に Common Lisp 互換のリスト操作ユーティリティを定義する。これにより、Spinor 言語のリスト操作機能を強化し、より表現豊かなプログラム記述を可能にする。既存の `length`, `append`, `reverse` 関数については Common Lisp との互換性を考慮した調整を行う。

## 仕様

### 1. `list`
*   **CLHS互換:** `(list &rest arguments)`
*   **説明:** 0個以上の引数を取り、それらの引数を要素とする新しいリストを構築して返す。
*   **引数:** 任意の数の値。
*   **戻り値:** 引数を要素とする新しいリスト。
*   **挙動:**
    *   引数がない場合、空リスト `()` を返す。
    *   引数は評価される。
*   **例:**
    ```spinor
    (list 1 2 3)  ; => (1 2 3)
    (list)        ; => ()
    (list (list 1) (list 2 3)) ; => ((1) (2 3))
    ```

### 2. `append`
*   **CLHS互換:** `(append &rest lists)`
*   **説明:** 2つ以上のリストを連結し、新しいリストとして返す。最後の引数のみがそのまま共有され、それ以外のリストはコピーされる。
*   **引数:** 任意の数のリスト（ただし、最後の引数以外はリストである必要がある）。
*   **戻り値:** 連結された新しいリスト。
*   **挙動:**
    *   引数がない場合、空リスト `()` を返す。
    *   引数が1つだけの場合、そのリストがそのまま（コピーされずに）返される。
    *   最後の引数がリストでない場合、エラーとなる。
    *   既存の `append` 関数は2引数固定であるため、CLHS互換の多引数版に更新する。
*   **例:**
    ```spinor
    (append (list 1 2) (list 3 4))  ; => (1 2 3 4)
    (append (list 1) (list 2) (list 3)) ; => (1 2 3)
    (append (list 1 2) nil (list 3)) ; => (1 2 3)
    (append) ; => ()
    (append (list 1 2)) ; => (1 2)
    ```

### 3. `member`
*   **CLHS互換:** `(member item list &key test test-not key)`
*   **説明:** `item` が `list` の要素に含まれるかを判定する。含まれる場合、その `item` から始まるサブリストを返し、含まれない場合は `nil` を返す。比較は要素の等価性 (`equal?`) に基づく。キーワード引数 (`test`, `test-not`, `key`) は現在のSpinorの仕様ではサポートしない。
*   **引数:**
    *   `item`: リスト内で検索する要素。
    *   `list`: 検索対象のリスト。
*   **戻り値:** `item` がリストに含まれる場合、その `item` から始まるサブリスト。含まれない場合は `nil`。
*   **挙動:**
    *   リストの要素と `item` は `equal?` 関数で比較される。
    *   検索はリストの最初から行われ、最初に一致した要素が見つかった時点でそのサブリストを返す。
    *   `item` が `nil` で、`list` が `nil` を含む場合、`nil` から始まるサブリストを返す。
*   **例:**
    ```spinor
    (member 3 (list 1 2 3 4 5)) ; => (3 4 5)
    (member 6 (list 1 2 3))     ; => nil
    (member nil (list 1 nil 2)) ; => (nil 2)
    (member (list 2 3) (list 1 (list 2 3) 4)) ; => ((2 3) 4)
    ```

### 4. `nth`
*   **CLHS互換:** `(nth n list)`
*   **説明:** `list` の `n` 番目の要素（0-indexed）を返す。
*   **引数:**
    *   `n`: 取得したい要素のインデックス (非負整数)。
    *   `list`: 対象のリスト。
*   **戻り値:** `list` の `n` 番目の要素。
*   **挙動:**
    *   `n` が負の数である場合、エラーとなる。
    *   `n` がリストの長さを超える場合、またはリストが空の場合、`nil` を返す。
*   **例:**
    ```spinor
    (nth 0 (list 10 20 30)) ; => 10
    (nth 2 (list 10 20 30)) ; => 30
    (nth 3 (list 10 20 30)) ; => nil
    (nth 0 nil)             ; => nil
    ```

### 5. `reverse`
*   **CLHS互換:** `(reverse list)`
*   **説明:** `list` の要素を逆順にした新しいリストを返す。元のリストは変更されない。
*   **引数:** `list`: 対象のリスト。
*   **戻り値:** 要素が逆順になった新しいリスト。
*   **挙動:**
    *   空リストが与えられた場合、空リストを返す。
    *   既存の `reverse` 関数はそのまま CLHS 互換であるため、仕様の確認のみでよい。
*   **例:**
    ```spinor
    (reverse (list 1 2 3)) ; => (3 2 1)
    (reverse nil)          ; => nil
    ```

### 6. `length`
*   **CLHS互換:** `(length sequence)`
*   **説明:** リスト（または一般的なシーケンス）の要素数を返す。
*   **引数:** `sequence`: 対象のリスト。
*   **戻り値:** リストの要素数 (非負整数)。
*   **挙動:**
    *   空リストが与えられた場合、`0` を返す。
    *   既存の `length` 関数はそのまま CLHS 互換であるため、仕様の確認のみでよい。
*   **例:**
    ```spinor
    (length (list 1 2 3)) ; => 3
    (length nil)          ; => 0
    ```

## 留意事項
*   Common Lisp のキーワード引数 (`:test`, `:key` など) は現時点ではサポートしない。
*   エラー処理については、現在の Spinor カーネルの挙動に準拠する。例えば、不正な型の引数が渡された場合、適切な実行時エラーが発生する。
---
