<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Documentation - Spinor</title>
  <meta name="description" content="Spinor Documentation">
  <link rel="stylesheet" href="style.css">

  <!-- GitHub Markdown CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.5.1/github-markdown-light.min.css">

  <!-- Highlight.js Theme -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
</head>
<body>

  <!-- Header -->
  <header id="header">
    <nav>
      <a href="index.html" class="logo">
        <img src="assets/spinor-logo.png" alt="Spinor" class="logo-img">
        <span class="logo-text">Spinor</span>
      </a>
      <ul class="nav-links">
        <li><a href="doc.html?src=reference.md">Reference</a></li>
        <li><a href="doc.html?src=emacs.md">Emacs</a></li>
        <li><a href="https://github.com/yanqirenshi/Spinor">GitHub</a></li>
      </ul>
    </nav>
  </header>

  <main class="doc-layout">
    <!-- Sidebar Navigation -->
    <aside class="doc-sidebar">
      <nav class="sidebar-nav">
        <h3>Documentation</h3>
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="doc.html?src=reference.md" data-src="reference.md">Language Reference</a></li>
          <li><a href="doc.html?src=emacs.md" data-src="emacs.md">Emacs Integration</a></li>
        </ul>
      </nav>
    </aside>

    <!-- Main Content -->
    <section class="doc-main">
      <article id="content" class="markdown-body">
        <p>Loading...</p>
      </article>
    </section>
  </main>

  <!-- Footer -->
  <footer id="footer">
    <div class="footer-content">
      <p>&copy; 2026 Spinor Project</p>
      <ul class="footer-links">
        <li><a href="index.html">Home</a></li>
        <li><a href="https://github.com/yanqirenshi/Spinor">GitHub</a></li>
      </ul>
    </div>
  </footer>

  <!-- Highlight.js Core + Languages -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/lisp.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/haskell.min.js"></script>

  <!-- marked.js for Markdown rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    (function() {
      'use strict';

      // Get the 'src' parameter from URL
      const params = new URLSearchParams(window.location.search);
      const src = params.get('src');

      // Security: Only allow specific file patterns (no directory traversal)
      function isValidSource(s) {
        if (!s) return false;
        // Allow subdirectories (alphanumeric, hyphen, underscore) with .md extension
        // Reject directory traversal (..)
        if (s.includes('..')) return false;
        return /^[a-zA-Z0-9_/-]+\.md$/.test(s);
      }

      // Render error message
      function showError(message) {
        const content = document.getElementById('content');
        content.innerHTML = '<div class="doc-error"><h2>Error</h2><p>' + message + '</p><p><a href="index.html">Back to Home</a></p></div>';
      }

      // Highlight active navigation link
      function updateActiveLink() {
        const links = document.querySelectorAll('.sidebar-nav a[data-src]');
        links.forEach(link => {
          link.classList.remove('active');
          if (link.getAttribute('data-src') === src) {
            link.classList.add('active');
          }
        });
      }

      // Fetch and render Markdown
      async function loadDocument() {
        if (!isValidSource(src)) {
          showError('Invalid document source. Please specify a valid Markdown file.');
          return;
        }

        try {
          const response = await fetch(src);
          if (!response.ok) {
            throw new Error('Document not found: ' + src);
          }

          const markdown = await response.text();
          const html = marked.parse(markdown);

          const content = document.getElementById('content');
          content.innerHTML = html;

          // Extract title from first h1 and set document title
          const firstH1 = content.querySelector('h1');
          if (firstH1) {
            document.title = firstH1.textContent + ' - Spinor';
          }

          // Apply syntax highlighting
          content.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightElement(block);
          });

          // Update active nav link
          updateActiveLink();

        } catch (error) {
          showError(error.message);
        }
      }

      // Load document when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadDocument);
      } else {
        loadDocument();
      }
    })();
  </script>
</body>
</html>
